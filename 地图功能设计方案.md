# DRMP机构管理模块地图功能设计方案

## 1. 整体设计理念

### 1.1 功能定位
- **案源机构地图**：展示全国案件分布热力图，帮助了解案件来源地域分布
- **处置机构地图**：展示全国处置机构分布图，帮助优化资源配置和区域覆盖

### 1.2 技术选型
- **地图引擎**：高德地图 (AMap) / 百度地图 (BMap) 
- **可视化库**：ECharts地图组件
- **数据格式**：GeoJSON + 统计数据
- **交互方式**：点击、悬停、区域选择、图层切换

## 2. 案源机构全国案件分布地图

### 2.1 功能概述
展示全国各省市区的案件分布情况，包括案件数量、金额分布、案件类型分布等维度的可视化分析。

### 2.2 数据模型设计
```typescript
// 案件地理分布数据
interface CaseGeoDistribution {
  // 省级数据
  provinceData: Array<{
    provinceCode: string;          // 省份代码
    provinceName: string;          // 省份名称
    totalCases: number;            // 案件总数
    totalAmount: string;           // 案件总金额
    avgAmount: number;             // 平均案件金额
    caseTypes: Array<{            // 案件类型分布
      type: string;
      count: number;
      percentage: number;
    }>;
    monthlyTrend: Array<{         // 月度趋势
      month: string;
      cases: number;
      amount: string;
    }>;
    topSourceOrgs: Array<{        // 主要案源机构
      orgId: number;
      orgName: string;
      cases: number;
      amount: string;
    }>;
  }>;
  
  // 城市级数据
  cityData: Array<{
    cityCode: string;
    cityName: string;
    provinceCode: string;
    coordinates: [number, number]; // 经纬度
    totalCases: number;
    totalAmount: string;
    density: number;               // 案件密度
    sourceOrgCount: number;        // 案源机构数量
  }>;
  
  // 热力图数据
  heatmapData: Array<{
    coordinates: [number, number];
    value: number;                 // 热力值
    cases: number;
    amount: string;
  }>;
}
```

### 2.3 地图功能设计

#### 2.3.1 多层级展示
```typescript
// 地图层级配置
interface MapLevelConfig {
  country: {
    zoom: [3, 5];
    showProvinces: true;
    showCities: false;
    showHeatmap: true;
  };
  province: {
    zoom: [6, 8];
    showProvinces: true;
    showCities: true;
    showHeatmap: true;
  };
  city: {
    zoom: [9, 12];
    showProvinces: false;
    showCities: true;
    showHeatmap: true;
    showDistricts: true;
  };
}
```

#### 2.3.2 可视化图层
1. **省份填充图层**
   - 按案件数量填充颜色深浅
   - 支持数量、金额、密度等维度切换
   - 颜色梯度：浅蓝→深蓝→红色

2. **城市标记图层**
   - 圆形标记表示城市案件情况
   - 标记大小对应案件数量
   - 颜色对应案件密度

3. **热力图图层**
   - 案件分布热力图
   - 可调节热力图透明度
   - 支持实时数据更新

4. **机构分布图层**
   - 案源机构位置标记
   - 机构类型用不同图标表示
   - 点击显示机构详细信息

#### 2.3.3 交互功能
```typescript
interface MapInteraction {
  // 区域选择
  onRegionClick: (region: {
    type: 'province' | 'city';
    code: string;
    name: string;
    data: any;
  }) => void;
  
  // 悬停信息
  onRegionHover: (region: {
    name: string;
    cases: number;
    amount: string;
    density: number;
  }) => void;
  
  // 机构标记点击
  onOrgMarkerClick: (org: {
    id: number;
    name: string;
    type: string;
    cases: number;
    amount: string;
  }) => void;
  
  // 地图缩放
  onZoomChange: (zoom: number, center: [number, number]) => void;
}
```

### 2.4 统计面板设计
```typescript
interface CaseMapStatistics {
  // 全国总览
  national: {
    totalCases: number;
    totalAmount: string;
    avgCaseAmount: number;
    topProvinces: Array<{
      name: string;
      cases: number;
      percentage: number;
    }>;
  };
  
  // 区域对比
  regionComparison: Array<{
    region: string;
    cases: number;
    amount: string;
    growth: number;           // 同比增长
    rank: number;             // 排名
  }>;
  
  // 案件类型分布
  typeDistribution: Array<{
    type: string;
    count: number;
    percentage: number;
    avgAmount: number;
  }>;
  
  // 时间趋势
  timeTrend: Array<{
    period: string;
    cases: number;
    amount: string;
  }>;
}
```

## 3. 处置机构全国分布地图

### 3.1 功能概述
展示全国处置机构的地理分布、服务覆盖范围、处置能力分布等信息，支持资源配置优化和空白区域识别。

### 3.2 数据模型设计
```typescript
// 处置机构地理分布数据
interface DisposalOrgGeoDistribution {
  // 机构分布数据
  orgDistribution: Array<{
    orgId: number;
    orgName: string;
    type: 'MEDIATION_CENTER' | 'LAW_FIRM' | 'COLLECTION_AGENCY' | 'OTHER';
    coordinates: [number, number];
    address: string;
    
    // 能力信息
    teamSize: number;
    monthlyCapacity: number;
    currentLoad: number;
    utilization: number;
    
    // 服务范围
    serviceRadius: number;        // 服务半径(km)
    serviceRegions: string[];     // 服务区域列表
    
    // 业绩信息
    totalCases: number;
    avgRecoveryRate: number;
    performanceRating: string;
    
    // 状态信息
    status: 'ACTIVE' | 'SUSPENDED' | 'OVERLOADED';
    membershipStatus: 'ACTIVE' | 'EXPIRED' | 'UNPAID';
  }>;
  
  // 区域统计
  regionStats: Array<{
    regionCode: string;
    regionName: string;
    regionType: 'province' | 'city';
    
    // 机构统计
    totalOrgs: number;
    activeOrgs: number;
    orgTypes: Array<{
      type: string;
      count: number;
    }>;
    
    // 能力统计
    totalCapacity: number;
    usedCapacity: number;
    avgUtilization: number;
    
    // 覆盖情况
    coverageRate: number;         // 区域覆盖率
    serviceGaps: Array<{          // 服务空白点
      area: string;
      coordinates: [number, number];
      priority: 'HIGH' | 'MEDIUM' | 'LOW';
    }>;
  }>;
  
  // 服务覆盖数据
  serviceCoverage: Array<{
    orgId: number;
    coverageArea: {
      type: 'circle' | 'polygon';
      coordinates: Array<[number, number]>;
      radius?: number;
    };
    serviceQuality: number;       // 服务质量评分
  }>;
}
```

### 3.3 地图功能设计

#### 3.3.1 机构标记系统
```typescript
// 机构标记配置
interface OrgMarkerConfig {
  // 按机构类型分类
  markerTypes: {
    MEDIATION_CENTER: {
      icon: 'mediation-icon';
      color: '#1890ff';
      size: 'medium';
    };
    LAW_FIRM: {
      icon: 'law-icon';
      color: '#52c41a';
      size: 'medium';
    };
    COLLECTION_AGENCY: {
      icon: 'collection-icon';
      color: '#faad14';
      size: 'medium';
    };
    OTHER: {
      icon: 'other-icon';
      color: '#8c8c8c';
      size: 'small';
    };
  };
  
  // 按状态分类
  statusStyles: {
    ACTIVE: { opacity: 1.0, border: 'solid' };
    SUSPENDED: { opacity: 0.5, border: 'dashed' };
    OVERLOADED: { opacity: 1.0, border: 'thick', color: '#ff4d4f' };
  };
  
  // 按业绩分级
  performanceStyles: {
    'A+': { glow: true, size: 'large' };
    'A': { glow: false, size: 'large' };
    'B': { glow: false, size: 'medium' };
    'C': { glow: false, size: 'small' };
  };
}
```

#### 3.3.2 服务覆盖可视化
1. **服务半径圈**
   - 每个机构显示服务覆盖半径
   - 半径大小表示服务能力
   - 颜色深浅表示服务质量

2. **覆盖密度热力图**
   - 显示服务覆盖密度
   - 识别服务空白区域
   - 高亮资源不足区域

3. **能力分布图**
   - 按处置能力显示机构大小
   - 颜色表示产能利用率
   - 动态显示负载状态

#### 3.3.3 智能分析功能
```typescript
interface MapAnalytics {
  // 覆盖分析
  coverageAnalysis: {
    totalCoverageRate: number;
    uncoveredAreas: Array<{
      area: string;
      coordinates: [number, number];
      estimatedDemand: number;
      priority: number;
    }>;
    overlapAreas: Array<{
      area: string;
      orgCount: number;
      competition: 'HIGH' | 'MEDIUM' | 'LOW';
    }>;
  };
  
  // 负载均衡分析
  loadBalanceAnalysis: {
    overloadedOrgs: Array<{
      orgId: number;
      orgName: string;
      utilization: number;
      excessLoad: number;
    }>;
    underutilizedOrgs: Array<{
      orgId: number;
      orgName: string;
      utilization: number;
      availableCapacity: number;
    }>;
    recommendations: Array<{
      type: 'REDISTRIBUTE' | 'EXPAND' | 'NEW_ORG';
      description: string;
      priority: number;
    }>;
  };
  
  // 区域优化建议
  optimizationSuggestions: Array<{
    region: string;
    issue: string;
    suggestion: string;
    expectedImprovement: string;
    implementationCost: 'LOW' | 'MEDIUM' | 'HIGH';
  }>;
}
```

### 3.4 交互功能设计
```typescript
interface DisposalMapInteraction {
  // 机构选择
  onOrgSelect: (org: {
    id: number;
    name: string;
    type: string;
    capacity: number;
    utilization: number;
    performance: string;
  }) => void;
  
  // 区域分析
  onRegionAnalysis: (region: {
    name: string;
    orgCount: number;
    totalCapacity: number;
    coverageRate: number;
    serviceGaps: any[];
  }) => void;
  
  // 服务覆盖切换
  onCoverageToggle: (showCoverage: boolean) => void;
  
  // 筛选条件
  onFilterChange: (filters: {
    orgTypes: string[];
    performanceLevel: string[];
    membershipStatus: string[];
    utilizationRange: [number, number];
  }) => void;
  
  // 路径规划
  onRouteOptimization: (params: {
    startPoint: [number, number];
    targetOrgs: number[];
    optimizeBy: 'DISTANCE' | 'CAPACITY' | 'PERFORMANCE';
  }) => void;
}
```

## 4. 技术实现方案

### 4.1 前端组件架构
```typescript
// 地图组件结构
components/
├── MapContainer/              // 地图容器组件
│   ├── BaseMap.tsx           // 基础地图组件
│   ├── MapControls.tsx       // 地图控制组件
│   └── MapLegend.tsx         // 图例组件
├── CaseDistributionMap/      // 案件分布地图
│   ├── CaseHeatmap.tsx       // 案件热力图
│   ├── ProvinceLayer.tsx     // 省份图层
│   ├── CityMarkers.tsx       // 城市标记
│   └── CaseStatPanel.tsx     // 统计面板
├── DisposalOrgMap/           // 处置机构地图
│   ├── OrgMarkers.tsx        // 机构标记
│   ├── ServiceCoverage.tsx   // 服务覆盖
│   ├── CapacityHeatmap.tsx   // 能力热力图
│   └── AnalyticsPanel.tsx    // 分析面板
└── MapUtils/                 // 地图工具
    ├── GeoDataProcessor.ts   // 地理数据处理
    ├── MapCalculations.ts    // 地图计算
    └── MapAnimations.ts      // 地图动画
```

### 4.2 地图配置管理
```typescript
// 地图配置
interface MapConfig {
  // 基础配置
  baseConfig: {
    center: [116.397, 39.916];      // 北京为中心
    zoom: 5;
    minZoom: 3;
    maxZoom: 18;
    mapStyle: 'normal' | 'satellite' | 'dark';
  };
  
  // 主题配置
  themes: {
    light: {
      backgroundColor: '#f0f2f5';
      regionColor: '#e6f7ff';
      borderColor: '#91d5ff';
      textColor: '#000000';
    };
    dark: {
      backgroundColor: '#141414';
      regionColor: '#1f1f1f';
      borderColor: '#434343';
      textColor: '#ffffff';
    };
  };
  
  // 动画配置
  animations: {
    markerAppear: {
      duration: 800;
      easing: 'easeOutBounce';
    };
    regionHighlight: {
      duration: 300;
      easing: 'easeInOut';
    };
    dataUpdate: {
      duration: 1000;
      easing: 'easeInOutCubic';
    };
  };
}
```

### 4.3 数据处理流程
```typescript
// 地图数据处理服务
class MapDataService {
  // 案件地理数据处理
  async processCaseGeoData(rawData: any[]): Promise<CaseGeoDistribution> {
    // 1. 数据清洗和验证
    const cleanData = this.validateAndCleanData(rawData);
    
    // 2. 地理编码和坐标转换
    const geoCodedData = await this.geocodeAddresses(cleanData);
    
    // 3. 按地区聚合统计
    const aggregatedData = this.aggregateByRegion(geoCodedData);
    
    // 4. 生成热力图数据
    const heatmapData = this.generateHeatmapData(aggregatedData);
    
    return {
      provinceData: aggregatedData.provinces,
      cityData: aggregatedData.cities,
      heatmapData: heatmapData
    };
  }
  
  // 处置机构分布数据处理
  async processDisposalOrgData(rawData: any[]): Promise<DisposalOrgGeoDistribution> {
    // 1. 机构位置验证
    const validatedOrgs = await this.validateOrgLocations(rawData);
    
    // 2. 服务覆盖计算
    const coverageData = this.calculateServiceCoverage(validatedOrgs);
    
    // 3. 区域统计计算
    const regionStats = this.calculateRegionStatistics(validatedOrgs);
    
    // 4. 空白区域识别
    const serviceGaps = this.identifyServiceGaps(coverageData, regionStats);
    
    return {
      orgDistribution: validatedOrgs,
      regionStats: regionStats,
      serviceCoverage: coverageData
    };
  }
}
```

### 4.4 性能优化策略
```typescript
// 性能优化配置
interface MapPerformanceConfig {
  // 数据分层加载
  dataLayers: {
    level1: { zoom: [1, 6], maxPoints: 100 };    // 省级数据
    level2: { zoom: [7, 10], maxPoints: 500 };   // 市级数据
    level3: { zoom: [11, 18], maxPoints: 2000 }; // 详细数据
  };
  
  // 缓存策略
  cache: {
    mapTiles: { maxAge: 86400000 };       // 地图瓦片缓存24小时
    geoData: { maxAge: 3600000 };         // 地理数据缓存1小时
    statistics: { maxAge: 1800000 };      // 统计数据缓存30分钟
  };
  
  // 渲染优化
  rendering: {
    clustering: true;                     // 启用标记聚合
    clusterMaxZoom: 10;                   // 聚合最大缩放级别
    virtualization: true;                 // 虚拟化渲染
    throttleDelay: 200;                   // 节流延迟
  };
}
```

## 5. 后端API设计

### 5.1 案件地理分布API
```java
@RestController
@RequestMapping("/api/v1/geo/cases")
public class CaseGeoController {
    
    @GetMapping("/distribution")
    public ApiResponse<CaseGeoDistribution> getCaseDistribution(
            @RequestParam(required = false) String timeRange,
            @RequestParam(required = false) String caseType,
            @RequestParam(required = false) String amountRange,
            @RequestParam(required = false) List<String> regions) {
        // 获取案件地理分布数据
    }
    
    @GetMapping("/heatmap")
    public ApiResponse<List<HeatmapPoint>> getCaseHeatmap(
            @RequestParam String level, // province, city, district
            @RequestParam(required = false) String region) {
        // 获取热力图数据
    }
    
    @GetMapping("/statistics/{region}")
    public ApiResponse<RegionCaseStats> getRegionStatistics(
            @PathVariable String region,
            @RequestParam(required = false) String timeRange) {
        // 获取区域统计数据
    }
}
```

### 5.2 处置机构地理分布API
```java
@RestController
@RequestMapping("/api/v1/geo/disposal-orgs")
public class DisposalOrgGeoController {
    
    @GetMapping("/distribution")
    public ApiResponse<DisposalOrgGeoDistribution> getOrgDistribution(
            @RequestParam(required = false) List<String> orgTypes,
            @RequestParam(required = false) String performanceLevel,
            @RequestParam(required = false) String membershipStatus,
            @RequestParam(required = false) List<String> regions) {
        // 获取机构地理分布数据
    }
    
    @GetMapping("/coverage-analysis")
    public ApiResponse<CoverageAnalysis> getCoverageAnalysis(
            @RequestParam(required = false) String region) {
        // 获取覆盖分析数据
    }
    
    @GetMapping("/capacity-heatmap")
    public ApiResponse<List<CapacityHeatmapPoint>> getCapacityHeatmap() {
        // 获取能力分布热力图数据
    }
    
    @PostMapping("/optimization-suggestions")
    public ApiResponse<List<OptimizationSuggestion>> getOptimizationSuggestions(
            @RequestBody OptimizationRequest request) {
        // 获取优化建议
    }
}
```

## 6. 数据库设计

### 6.1 地理数据表
```sql
-- 地理区域表
CREATE TABLE geo_regions (
    id BIGINT PRIMARY KEY,
    region_code VARCHAR(20) UNIQUE,
    region_name VARCHAR(100),
    region_type ENUM('COUNTRY', 'PROVINCE', 'CITY', 'DISTRICT'),
    parent_code VARCHAR(20),
    coordinates TEXT,               -- GeoJSON格式
    center_lng DECIMAL(10, 7),      -- 中心经度
    center_lat DECIMAL(10, 7),      -- 中心纬度
    INDEX idx_parent_code (parent_code),
    INDEX idx_region_type (region_type)
);

-- 案件地理分布统计表
CREATE TABLE case_geo_stats (
    id BIGINT PRIMARY KEY,
    region_code VARCHAR(20),
    stat_date DATE,
    case_count INT DEFAULT 0,
    case_amount DECIMAL(15, 2) DEFAULT 0,
    avg_amount DECIMAL(15, 2) DEFAULT 0,
    case_density DECIMAL(8, 4) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_region_date (region_code, stat_date),
    INDEX idx_date (stat_date)
);

-- 机构地理位置表
CREATE TABLE org_geo_locations (
    id BIGINT PRIMARY KEY,
    org_id BIGINT,
    longitude DECIMAL(10, 7),       -- 经度
    latitude DECIMAL(10, 7),        -- 纬度
    address VARCHAR(500),
    region_code VARCHAR(20),
    service_radius INT DEFAULT 50,  -- 服务半径(km)
    geo_hash VARCHAR(20),           -- GeoHash索引
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_org_id (org_id),
    INDEX idx_geo_hash (geo_hash),
    INDEX idx_location (longitude, latitude)
);
```

## 7. 部署和运维

### 7.1 地图服务配置
```yaml
# 地图服务配置
map:
  provider: "amap"                  # 地图提供商
  api-key: "${MAP_API_KEY}"
  features:
    - "base-map"
    - "satellite"
    - "heatmap"
    - "clustering"
  
  cache:
    enabled: true
    redis-key-prefix: "drmp:map:"
    default-ttl: 3600
  
  performance:
    max-markers: 2000
    cluster-enabled: true
    lazy-loading: true
```

### 7.2 监控指标
```yaml
# 地图功能监控指标
metrics:
  map-performance:
    - "map_load_time"              # 地图加载时间
    - "data_fetch_time"            # 数据获取时间
    - "marker_render_time"         # 标记渲染时间
    - "interaction_response_time"  # 交互响应时间
  
  data-quality:
    - "geo_data_accuracy"          # 地理数据准确性
    - "coordinate_validity"        # 坐标有效性
    - "coverage_completeness"      # 覆盖完整性
  
  user-behavior:
    - "map_zoom_levels"            # 用户缩放级别分布
    - "region_click_frequency"     # 区域点击频率
    - "feature_usage_stats"        # 功能使用统计
```

这个地图功能设计方案将大大提升DRMP平台的可视化分析能力，为业务决策提供强有力的地理分析支持！